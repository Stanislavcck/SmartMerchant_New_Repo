# SmartMerchant 

## üìÑ –û–≥–ª—è–¥
**SmartMerchant** ‚Äî  —Ü–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–ª–∞—Ç–µ–∂—ñ–≤, –ø–æ–±—É–¥–æ–≤–∞–Ω–∞ –Ω–∞ ASP.NET Core 9.0 —ñ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –ø—ñ–¥—Ö–æ–¥—É —à–∞—Ä–æ–≤–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏. –°–∏—Å—Ç–µ–º–∞ –¥–æ–∑–≤–æ–ª—è—î –º–µ—Ä—á–∞–Ω—Ç–∞–º —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∞–∫–∞—É–Ω—Ç–∏, –∫–µ—Ä—É–≤–∞—Ç–∏ —ñ–Ω–≤–æ–π—Å–∞–º–∏, –ø—Ä–æ–≤–æ–¥–∏—Ç–∏ –ø–ª–∞—Ç–µ–∂—ñ —Ç–∞ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —á–µ—Ä–µ–∑ –≤–µ–±‚Äë—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ñ—à–µ–Ω–Ω—è
```
/
‚îú‚îÄ‚îÄ SmartMerchant.Domain/        # –¥–æ–º–µ–Ω–Ω—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ (POCO)
‚îú‚îÄ‚îÄ SmartMerchant.Application/   # –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫–∞ (Managers) + –¥–æ—Å—Ç—É–ø –¥–æ –¥–∞–Ω–∏—Ö (Repository)
‚îú‚îÄ‚îÄ SmartMerchant.WEB/           # UI (Razor Pages) + API Controllers + Middleware
‚îî‚îÄ‚îÄ SmartMerchant.Tests/         # –º–æ–¥—É–ª—å–Ω—ñ —Ç–µ—Å—Ç–∏ (xUnit, EF InMemory)
```

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥
- **–®–∞—Ä–æ–≤–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞**: `WEB ‚Üí Application ‚Üí Domain`.
- **Repository pattern**: —É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–∏–π `IRepository<T>` –¥–ª—è CRUD —Ç–∞ –∑–∞–ø–∏—Ç—ñ–≤.
- **Manager (service layer)**: –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫–∞ –≤–∏–Ω–µ—Å–µ–Ω–∞ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∏ (`Authorization`, `Merchant`, `Invoice`, `Card`, `Dashboard`).
- **DI (Dependency Injection)**: —Å–µ—Ä–≤—ñ—Å–∏ —Ä–µ—î—Å—Ç—Ä—É—é—Ç—å—Å—è –≤ `Program.cs`.

## üß∞ –¢–µ—Ö–Ω—ñ—á–Ω–∏–π —Å—Ç–µ–∫
- **Backend**: .NET 9, ASP.NET Core, EF Core 9, PostgreSQL (Npgsql), Newtonsoft.Json, Swagger/OpenAPI.
- **Frontend**: Razor Pages + JavaScript/AJAX, Tailwind CSS + –∫–∞—Å—Ç–æ–º–Ω—ñ —Å—Ç–∏–ª—ñ.
- **Testing**: xUnit, EF Core InMemory (—ñ–∑–æ–ª—è—Ü—ñ—è —Ç–µ—Å—Ç—ñ–≤).

## üîÅ –û—Å–Ω–æ–≤–Ω—ñ –ø–æ—Ç–æ–∫–∏
**–¢–∏–ø–æ–≤–∏–π –∑–∞–ø–∏—Ç**: HTTP ‚Üí Middleware ‚Üí Controller/PageModel ‚Üí Manager ‚Üí Repository ‚Üí EF Core ‚Üí PostgreSQL ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥—å (JSON/View).

**–û–ø–ª–∞—Ç–∞ —ñ–Ω–≤–æ–π—Å—É (—É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–æ)**:
1) –∫–ª—ñ—î–Ω—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –¥–∞–Ω—ñ –∫–∞—Ä—Ç–∫–∏ ‚Üí `POST /api/payment/pay`  
2) –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–∞—Ä—Ç–∫–∏/–±–∞–ª–∞–Ω—Å—É —Ç–∞ —ñ–Ω–≤–æ–π—Å—É ‚Üí —Å–ø–∏—Å–∞–Ω–Ω—è –∑ –∫–∞—Ä—Ç–∫–∏ ‚Üí –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –º–µ—Ä—á–∞–Ω—Ç—É (–∑ –∫–æ–º—ñ—Å—ñ—î—é) ‚Üí —ñ–Ω–≤–æ–π—Å `paid` ‚Üí –∑–∞–ø–∏—Å –≤ —ñ—Å—Ç–æ—Ä—ñ—é.

## üîê –ë–µ–∑–ø–µ–∫–∞ (–∫–æ—Ä–æ—Ç–∫–æ)
- **–°–µ—Å—ñ—ó**: —Ç–æ–∫–µ–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É —Ç–∞–±–ª–∏—Ü—ñ `UserSession`; –º–æ–∂–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ `Authorization: Bearer`, cookie –∞–±–æ query.
- **–ü–∞—Ä–æ–ª—ñ**: —Ö–µ—à—É–≤–∞–Ω–Ω—è + salt.
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ**: –æ–ø–µ—Ä–∞—Ü—ñ—ó –Ω–∞–¥ –º–µ—Ä—á–∞–Ω—Ç–æ–º/—ñ–Ω–≤–æ–π—Å–æ–º –æ–±–º–µ–∂–µ–Ω—ñ –≤–ª–∞—Å–Ω–∏–∫–æ–º –Ω–∞ —Ä—ñ–≤–Ω—ñ –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫–∏.

## üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Okta (Auth0)

- –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑—Ä–æ–±–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É **Auth0.AspNetCore.Authentication** (Okta/Auth0 Hosted Login + OIDC) —ñ **cookie‚Äë—Å–µ—Å—ñ—é**.
- –û—Å–Ω–æ–≤–Ω—ñ –µ–Ω–¥–ø–æ—ó–Ω—Ç–∏:
  - `GET /api/okta/login` ‚Äî —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ö–æ–¥—É Okta/Auth0.
  - `/signin-auth0` ‚Äî callback, —è–∫–∏–π –æ–±—Ä–æ–±–ª—è—î middleware Auth0.
  - `GET /api/okta/sync` ‚Äî –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –≤—Ö–æ–¥—É —á–∏—Ç–∞—î **claims** (email/nickname), —Å—Ç–≤–æ—Ä—é—î/–æ–Ω–æ–≤–ª—é—î –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Å—Ç–≤–æ—Ä—é—î `UserSession`‚Äë—Ç–æ–∫–µ–Ω, –ø—ñ–¥–ø–∏—Å—É—î cookie, –≤–∏—Å—Ç–∞–≤–ª—è—î cookie `authToken`, —Ä–µ–¥—ñ—Ä–µ–∫—Ç–∏—Ç—å —É `/Admin/Main`.
  - `GET|POST /api/okta/logout` ‚Äî –≤–∏—Ö—ñ–¥ (sign‚Äëout cookie + Auth0) —ñ –æ—á–∏—â–µ–Ω–Ω—è `authToken`.
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ `appsettings.json`: `Okta:Domain`, `Okta:ClientId`, `Okta:ClientSecret`.

## ‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

- –†—è–¥–æ–∫ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∞–¥–∞—î—Ç—å—Å—è –≤ `appsettings.json` ‚Üí `Services:Database`.
- –ü—Ä–æ–≤–∞–π–¥–µ—Ä –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ** –∑–∞ —Ä—è–¥–∫–æ–º –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:
  - **InMemory** ‚Äî —è–∫—â–æ –º—ñ—Å—Ç–∏—Ç—å `:memory:`
  - **SQLite** ‚Äî —è–∫—â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ `Data Source=...`
  - **PostgreSQL (Npgsql)** ‚Äî –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (–≤—Å—ñ —ñ–Ω—à—ñ –≤–∏–ø–∞–¥–∫–∏)
  - –ù–∞ —Å—Ç–∞—Ä—Ç—ñ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è `EnsureCreated()` —ñ **DatabaseSeeder** –Ω–∞–ø–æ–≤–Ω—é—î –ë–î –ø–æ—á–∞—Ç–∫–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏

## üóÑÔ∏è –î–∞–Ω—ñ (–æ—Å–Ω–æ–≤–Ω—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ)
`User`, `Merchant`, `MerchantInvoice`, `CreditCard` (–º–æ–∫), `UserSession`, `TransactionHistory`.

## ‚úÖ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
–ú–æ–¥—É–ª—å–Ω—ñ —Ç–µ—Å—Ç–∏ –∑ **in‚Äëmemory** –ë–î –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤ (—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è/–ª–æ–≥—ñ–Ω, –º–µ—Ä—á–∞–Ω—Ç, —ñ–Ω–≤–æ–π—Å–∏, –∫–∞—Ä—Ç–∫–∏, –¥–∞—à–±–æ—Ä–¥).

## üìå –ö–ª—é—á–æ–≤—ñ –¥–∏–∑–∞–π–Ω–µ—Ä—Å—å–∫—ñ —Ä—ñ—à–µ–Ω–Ω—è
- **Guid —è–∫ PK** –¥–ª—è —Å—É—Ç–Ω–æ—Å—Ç–µ–π.
- **`AsNoTracking()`** –¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ read‚Äë–∑–∞–ø–∏—Ç—ñ–≤, tracked‚Äë–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Äî —Ç–∞–º, –¥–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∞–ø–¥–µ–π—Ç–∏.
- **1 –º–µ—Ä—á–∞–Ω—Ç –Ω–∞ 1 –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (—É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å `OwnerUserGuid`).
- **–ö–æ–º—ñ—Å—ñ—è 3.99%** –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∏ –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—ñ –∫–æ—à—Ç—ñ–≤ –º–µ—Ä—á–∞–Ω—Ç—É.

---
